# =============================================================================
# atlantis.yaml â€” Repo-level Atlantis configuration
# =============================================================================
version: 3

# â”€â”€â”€ PROJECTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Each project can be triggered individually from a PR comment.
# Use `atlantis plan -p <name>` to target a specific project.
projects:

  # â”€â”€ Main project: full scan + terraform plan + apply â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Triggered automatically on PR push (autoplan) or with: atlantis plan
  - name: alantis-demo
    dir: .
    workspace: default              # default workspace = main state file
    workflow: all-scans-plan        # runs all 3 scanners + init + plan
    apply_requirements:
      - approved                    # PR must be approved before atlantis apply
    autoplan:
      when_modified:
        - "*.tf"
        - "*.tfvars"
        - "atlantis.yaml"
      enabled: true

  # â”€â”€ KICS scan only â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Trigger with: atlantis plan -p scan-kics
  # This only runs KICS, no terraform plan is generated.
  - name: scan-kics
    dir: .
    workspace: kics                 # separate workspace to avoid lock conflicts
    workflow: kics-only
    autoplan:
      enabled: false                # never auto-trigger; only on explicit command

  # â”€â”€ tfsec scan only â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Trigger with: atlantis plan -p scan-tfsec
  - name: scan-tfsec
    dir: .
    workspace: tfsec
    workflow: tfsec-only
    autoplan:
      enabled: false

  # â”€â”€ Checkov scan only â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Trigger with: atlantis plan -p scan-checkov
  - name: scan-checkov
    dir: .
    workspace: checkov
    workflow: checkov-only
    autoplan:
      enabled: false

# â”€â”€â”€ WORKFLOWS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
workflows:

  # â”€â”€ all-scans-plan: KICS cháº¡y TRÆ¯á»šC TIÃŠN (non-blocking) + export CSV â”€â”€â”€â”€â”€
  all-scans-plan:
    plan:
      steps:
        # âœ… BÆ¯á»šC 1: KICS scan â€” NON-BLOCKING + export CSV/JSON report
        # DÃ¹ KICS tÃ¬m tháº¥y lá»—i, cÃ¡c bÆ°á»›c tiáº¿p theo váº«n tiáº¿p tá»¥c cháº¡y
        # CSV report Ä‘Æ°á»£c lÆ°u táº¡i: /tmp/kics-report/<timestamp>-PR<num>/
        - run: |
            echo "=== [1/5] KICS security scan (non-blocking) ==="
            REPORT_DIR="/tmp/kics-report/$(date +%Y%m%d-%H%M%S)-PR${PULL_NUM}"
            mkdir -p "$REPORT_DIR"
            kics scan \
              -p . \
              -q /app/assets/queries \
              --no-progress \
              --type Terraform \
              --report-formats csv,json \
              --output-path "$REPORT_DIR" \
              --ignore-on-exit results > /dev/null 2>&1
            if [ -f "$REPORT_DIR/results.csv" ]; then
              TOTAL=$(awk -F',' 'NR>1' "$REPORT_DIR/results.csv" | wc -l)
              CRITICAL=$(awk -F',' 'NR>1 && toupper($4)=="CRITICAL"' "$REPORT_DIR/results.csv" | wc -l)
              HIGH=$(awk -F',' 'NR>1 && toupper($4)=="HIGH"' "$REPORT_DIR/results.csv" | wc -l)
              MED=$(awk -F',' 'NR>1 && toupper($4)=="MEDIUM"' "$REPORT_DIR/results.csv" | wc -l)
              echo "### ğŸ” KICS Security Scan Results"
              echo ""
              echo "| ğŸ“Š Total | ğŸ”´ Critical | ğŸŸ  High | ğŸŸ¡ Medium |"
              echo "|---------|------------|--------|----------|"
              echo "| $TOTAL | $CRITICAL | $HIGH | $MED |"
              echo ""
              FILTERED=$(awk -F',' 'NR>1 && (toupper($4)=="CRITICAL" || toupper($4)=="HIGH" || toupper($4)=="MEDIUM")' "$REPORT_DIR/results.csv" | wc -l)
              if [ "$FILTERED" -gt 0 ]; then
                echo "#### âš ï¸ Findings â€” Critical / High / Medium"
                echo ""
                echo "| Vulnerability | Severity | Resource | Description |"
                echo "|--------------|----------|------------|-------------|"
                awk -F',' 'NR>1 && (toupper($4)=="CRITICAL" || toupper($4)=="HIGH" || toupper($4)=="MEDIUM") {
                  title=$1; sev=$4; file=$9; line=$10; desc=$7
                  gsub(/^[[:space:]"]+|[[:space:]"]+$/, "", title)
                  gsub(/^[[:space:]"]+|[[:space:]"]+$/, "", sev)
                  gsub(/^[[:space:]"]+|[[:space:]"]+$/, "", file)
                  gsub(/^[[:space:]"]+|[[:space:]"]+$/, "", line)
                  gsub(/^[[:space:]"]+|[[:space:]"]+$/, "", desc)
                  printf "| %s | %s | %s:%s | %s |\n", title, sev, file, line, desc
                }' "$REPORT_DIR/results.csv"
              else
                echo "âœ… No CRITICAL / HIGH / MEDIUM findings."
              fi
            fi
            echo ""
            echo "=== KICS scan complete ==="

        - run: |
            echo "=== [2/5] tfsec security scan (non-blocking + JSON export) ==="
            REPORT_DIR="/tmp/tfsec-report/$(date +%Y%m%d-%H%M%S)-PR${PULL_NUM}"
            mkdir -p "$REPORT_DIR"
            tfsec . --no-color --soft-fail --format json > "$REPORT_DIR/results.json" 2>&1 || true
            tfsec . --no-color --soft-fail
            echo ""
            echo "ğŸ“ tfsec report saved to: $REPORT_DIR/results.json"
            echo "=== tfsec scan complete ==="

        - run: |
            echo "=== [3/5] Checkov security scan (non-blocking + CSV/JSON export) ==="
            REPORT_DIR="/tmp/checkov-report/$(date +%Y%m%d-%H%M%S)-PR${PULL_NUM}"
            mkdir -p "$REPORT_DIR"
            checkov -d . --quiet --compact --framework terraform --soft-fail \
              --output json > "$REPORT_DIR/results.json" 2>&1 || true
            checkov -d . --quiet --compact --framework terraform --soft-fail \
              --output csv > "$REPORT_DIR/results.csv" 2>&1 || true
            checkov -d . --compact --framework terraform --soft-fail
            echo ""
            echo "ğŸ“ Checkov report saved to: $REPORT_DIR"
            echo "   - CSV : $REPORT_DIR/results.csv"
            echo "   - JSON: $REPORT_DIR/results.json"
            echo "=== Checkov scan complete ==="

        - init   # BÆ°á»›c 4: terraform init
        - plan   # BÆ°á»›c 5: terraform plan (káº¿t quáº£ post lÃªn PR comment)

    apply:
      steps:
        - apply  # runs terraform apply with the saved plan file

  # â”€â”€ kics-only: KICS scan only + export CSV, no terraform plan â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Comment `atlantis plan -p scan-kics` on the PR to trigger.
  kics-only:
    plan:
      steps:
        - run: |
            echo "=== KICS security scan ==="
            REPORT_DIR="/tmp/kics-report/$(date +%Y%m%d-%H%M%S)-PR${PULL_NUM}"
            mkdir -p "$REPORT_DIR"
            kics scan \
              -p . \
              -q /app/assets/queries \
              --no-progress \
              --type Terraform \
              --report-formats csv,json \
              --output-path "$REPORT_DIR" \
              --ignore-on-exit results > /dev/null 2>&1
            if [ -f "$REPORT_DIR/results.csv" ]; then
              TOTAL=$(awk -F',' 'NR>1' "$REPORT_DIR/results.csv" | wc -l)
              CRITICAL=$(awk -F',' 'NR>1 && toupper($4)=="CRITICAL"' "$REPORT_DIR/results.csv" | wc -l)
              HIGH=$(awk -F',' 'NR>1 && toupper($4)=="HIGH"' "$REPORT_DIR/results.csv" | wc -l)
              MED=$(awk -F',' 'NR>1 && toupper($4)=="MEDIUM"' "$REPORT_DIR/results.csv" | wc -l)
              LOW=$(awk -F',' 'NR>1 && toupper($4)=="LOW"' "$REPORT_DIR/results.csv" | wc -l)
              INFO=$(awk -F',' 'NR>1 && toupper($4)=="INFO"' "$REPORT_DIR/results.csv" | wc -l)
              echo "### ğŸ” KICS Security Scan Results"
              echo ""
              echo "| ğŸ“Š Total | ğŸ”´ Critical | ğŸŸ  High | ğŸŸ¡ Medium | ğŸ”µ Low | âšª Info |"
              echo "|---------|------------|--------|----------|-------|------|"
              echo "| $TOTAL | $CRITICAL | $HIGH | $MED | $LOW | $INFO |"
              echo ""
              FILTERED=$(awk -F',' 'NR>1 && (toupper($4)=="CRITICAL" || toupper($4)=="HIGH" || toupper($4)=="MEDIUM")' "$REPORT_DIR/results.csv" | wc -l)
              if [ "$FILTERED" -gt 0 ]; then
                echo "#### âš ï¸ Findings â€” Critical / High / Medium"
                echo ""
                echo "| Vulnerability | Severity | Resource | Description |"
                echo "|--------------|----------|------------|-------------|"
                awk -F',' 'NR>1 && (toupper($4)=="CRITICAL" || toupper($4)=="HIGH" || toupper($4)=="MEDIUM") {
                  title=$1; sev=$4; file=$9; line=$10; desc=$7
                  gsub(/^[[:space:]"]+|[[:space:]"]+$/, "", title)
                  gsub(/^[[:space:]"]+|[[:space:]"]+$/, "", sev)
                  gsub(/^[[:space:]"]+|[[:space:]"]+$/, "", file)
                  gsub(/^[[:space:]"]+|[[:space:]"]+$/, "", line)
                  gsub(/^[[:space:]"]+|[[:space:]"]+$/, "", desc)
                  printf "| %s | %s | %s:%s | %s |\n", title, sev, file, line, desc
                }' "$REPORT_DIR/results.csv"
              else
                echo "âœ… No CRITICAL / HIGH / MEDIUM findings."
              fi
            fi
            echo ""
            echo "=== KICS scan complete ==="

  # â”€â”€ tfsec-only: tfsec scan only, no terraform plan â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Comment `atlantis plan -p scan-tfsec` on the PR to trigger.
  tfsec-only:
    plan:
      steps:
        - run: |
            echo "=== tfsec security scan (non-blocking + JSON export) ==="
            REPORT_DIR="/tmp/tfsec-report/$(date +%Y%m%d-%H%M%S)-PR${PULL_NUM}"
            mkdir -p "$REPORT_DIR"
            tfsec . --no-color --soft-fail --format json > "$REPORT_DIR/results.json" 2>&1 || true
            tfsec . --no-color --soft-fail
            echo ""
            echo "ğŸ“ tfsec report saved to: $REPORT_DIR/results.json"
            echo "=== tfsec scan complete ==="

  # â”€â”€ checkov-only: Checkov scan only, no terraform plan â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Comment `atlantis plan -p scan-checkov` on the PR to trigger.
  checkov-only:
    plan:
      steps:
        - run: |
            echo "=== Checkov security scan (non-blocking + CSV/JSON export) ==="
            REPORT_DIR="/tmp/checkov-report/$(date +%Y%m%d-%H%M%S)-PR${PULL_NUM}"
            mkdir -p "$REPORT_DIR"
            checkov -d . --quiet --compact --framework terraform --soft-fail \
              --output json > "$REPORT_DIR/results.json" 2>&1 || true
            checkov -d . --quiet --compact --framework terraform --soft-fail \
              --output csv > "$REPORT_DIR/results.csv" 2>&1 || true
            checkov -d . --compact --framework terraform --soft-fail
            echo ""
            echo "ğŸ“ Checkov report saved to: $REPORT_DIR"
            echo "   - CSV : $REPORT_DIR/results.csv"
            echo "   - JSON: $REPORT_DIR/results.json"
            echo "=== Checkov scan complete ==="
