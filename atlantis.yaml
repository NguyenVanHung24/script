# =============================================================================
# atlantis.yaml â€” Repo-level Atlantis configuration
# =============================================================================
version: 3

# â”€â”€â”€ PROJECTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Each project can be triggered individually from a PR comment.
# Use `atlantis plan -p <name>` to target a specific project.
projects:

  # â”€â”€ Main project: full scan + terraform plan + apply â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Triggered automatically on PR push (autoplan) or with: atlantis plan
  - name: alantis-demo
    dir: .
    workspace: default              # default workspace = main state file
    workflow: all-scans-plan        # runs all 3 scanners + init + plan
    apply_requirements:
      - approved                    # PR must be approved before atlantis apply
    autoplan:
      when_modified:
        - "*.tf"
        - "*.tfvars"
        - "atlantis.yaml"
      enabled: true

  # â”€â”€ KICS scan only â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Trigger with: atlantis plan -p scan-kics
  # This only runs KICS, no terraform plan is generated.
  - name: scan-kics
    dir: .
    workspace: kics                 # separate workspace to avoid lock conflicts
    workflow: kics-only
    autoplan:
      enabled: false                # never auto-trigger; only on explicit command

  # â”€â”€ tfsec scan only â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Trigger with: atlantis plan -p scan-tfsec
  - name: scan-tfsec
    dir: .
    workspace: tfsec
    workflow: tfsec-only
    autoplan:
      enabled: false

  # â”€â”€ Checkov scan only â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Trigger with: atlantis plan -p scan-checkov
  - name: scan-checkov
    dir: .
    workspace: checkov
    workflow: checkov-only
    autoplan:
      enabled: false

# â”€â”€â”€ WORKFLOWS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
workflows:

  # â”€â”€ all-scans-plan: KICS cháº¡y TRÆ¯á»šC TIÃŠN (non-blocking) + export CSV â”€â”€â”€â”€â”€
  all-scans-plan:
    plan:
      steps:
        # âœ… BÆ¯á»šC 1: KICS scan â€” NON-BLOCKING + export CSV/JSON report
        # DÃ¹ KICS tÃ¬m tháº¥y lá»—i, cÃ¡c bÆ°á»›c tiáº¿p theo váº«n tiáº¿p tá»¥c cháº¡y
        # CSV report Ä‘Æ°á»£c lÆ°u táº¡i: /tmp/kics-report/<timestamp>-PR<num>/
        - run: |
            echo "=== [1/5] KICS security scan (non-blocking) ==="
            REPORT_DIR="/tmp/kics-report/$(date +%Y%m%d-%H%M%S)-PR${PULL_NUM}"
            mkdir -p "$REPORT_DIR"
            kics scan \
              -p . \
              -q /app/assets/queries \
              --no-progress \
              --type Terraform \
              --report-formats csv,json \
              --output-path "$REPORT_DIR" \
              --ignore-on-exit results > /dev/null 2>&1
            if [ -f "$REPORT_DIR/results.csv" ]; then
              PY=/tmp/kics_parse_$$.py
              printf '%s\n' \
                'import csv,os,sys' \
                'f=os.environ.get("KICS_CSV","")' \
                'rows=[r for r in csv.reader(open(f)) if r][1:]' \
                'rows=[r for r in rows if len(r)>=17]' \
                'sev=lambda r:r[3].strip().upper()' \
                'total=len(rows)' \
                'cri=sum(1 for r in rows if sev(r)=="CRITICAL")' \
                'hi=sum(1 for r in rows if sev(r)=="HIGH")' \
                'med=sum(1 for r in rows if sev(r)=="MEDIUM")' \
                'print("### KICS Security Scan Results")' \
                'print("")' \
                'print("| Total | Critical | High | Medium |")' \
                'print("|-------|----------|------|--------|")'  \
                'print("| "+str(total)+" | "+str(cri)+" | "+str(hi)+" | "+str(med)+" |")' \
                'print("")' \
                'fil=[r for r in rows if sev(r) in ("CRITICAL","HIGH","MEDIUM")]' \
                'print("#### Findings - Critical / High / Medium") if fil else print("No CRITICAL/HIGH/MEDIUM findings.")' \
                'fil and [print("| Vulnerability | Severity | Resource | Description |")]' \
                'fil and [print("|--------------|----------|----------|-------------|" )]' \
                'exec("for r in fil:\n d=r[10][:117]+\x27...\x27 if len(r[10])>120 else r[10]\n print(\x27| \x27+r[0]+\x27 | \x27+r[3]+\x27 | \x27+r[14]+\x27:\x27+r[16]+\x27 | \x27+d+\x27 |\x27)")' \
                > "$PY"
              KICS_CSV="$REPORT_DIR/results.csv" python3 "$PY"
              rm -f "$PY"
            fi
            echo ""
            echo "=== KICS scan complete ==="

        - run: |
            echo "=== [2/5] tfsec security scan (non-blocking + JSON export) ==="
            REPORT_DIR="/tmp/tfsec-report/$(date +%Y%m%d-%H%M%S)-PR${PULL_NUM}"
            mkdir -p "$REPORT_DIR"
            tfsec . --no-color --soft-fail --format json > "$REPORT_DIR/results.json" 2>&1 || true
            tfsec . --no-color --soft-fail
            echo ""
            echo "ğŸ“ tfsec report saved to: $REPORT_DIR/results.json"
            echo "=== tfsec scan complete ==="

        - run: |
            echo "=== [3/5] Checkov security scan (non-blocking + CSV/JSON export) ==="
            REPORT_DIR="/tmp/checkov-report/$(date +%Y%m%d-%H%M%S)-PR${PULL_NUM}"
            mkdir -p "$REPORT_DIR"
            checkov -d . --quiet --compact --framework terraform --soft-fail \
              --output json > "$REPORT_DIR/results.json" 2>&1 || true
            checkov -d . --quiet --compact --framework terraform --soft-fail \
              --output csv > "$REPORT_DIR/results.csv" 2>&1 || true
            checkov -d . --compact --framework terraform --soft-fail
            echo ""
            echo "ğŸ“ Checkov report saved to: $REPORT_DIR"
            echo "   - CSV : $REPORT_DIR/results.csv"
            echo "   - JSON: $REPORT_DIR/results.json"
            echo "=== Checkov scan complete ==="

        - init   # BÆ°á»›c 4: terraform init
        - plan   # BÆ°á»›c 5: terraform plan (káº¿t quáº£ post lÃªn PR comment)

    apply:
      steps:
        - apply  # runs terraform apply with the saved plan file

  # â”€â”€ kics-only: KICS scan only + export CSV, no terraform plan â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Comment `atlantis plan -p scan-kics` on the PR to trigger.
  kics-only:
    plan:
      steps:
        - run: |
            echo "=== KICS security scan ==="
            REPORT_DIR="/tmp/kics-report/$(date +%Y%m%d-%H%M%S)-PR${PULL_NUM}"
            mkdir -p "$REPORT_DIR"
            kics scan \
              -p . \
              -q /app/assets/queries \
              --no-progress \
              --type Terraform \
              --report-formats csv,json \
              --output-path "$REPORT_DIR" \
              --ignore-on-exit results > /dev/null 2>&1
            if [ -f "$REPORT_DIR/results.csv" ]; then
              PY=/tmp/kics_parse_$$.py
              printf '%s\n' \
                'import csv,os,sys' \
                'f=os.environ.get("KICS_CSV","")' \
                'rows=[r for r in csv.reader(open(f)) if r][1:]' \
                'rows=[r for r in rows if len(r)>=17]' \
                'sev=lambda r:r[3].strip().upper()' \
                'total=len(rows)' \
                'cri=sum(1 for r in rows if sev(r)=="CRITICAL")' \
                'hi=sum(1 for r in rows if sev(r)=="HIGH")' \
                'med=sum(1 for r in rows if sev(r)=="MEDIUM")' \
                'low=sum(1 for r in rows if sev(r)=="LOW")' \
                'info=sum(1 for r in rows if sev(r)=="INFO")' \
                'print("### KICS Security Scan Results")' \
                'print("")' \
                'print("| Total | Critical | High | Medium | Low | Info |")' \
                'print("|-------|----------|------|--------|-----|------|")' \
                'print("| "+str(total)+" | "+str(cri)+" | "+str(hi)+" | "+str(med)+" | "+str(low)+" | "+str(info)+" |")' \
                'print("")' \
                'fil=[r for r in rows if sev(r) in ("CRITICAL","HIGH","MEDIUM")]' \
                'print("#### Findings - Critical / High / Medium") if fil else print("No CRITICAL/HIGH/MEDIUM findings.")' \
                'fil and [print("| Vulnerability | Severity | Resource | Description |")]' \
                'fil and [print("|--------------|----------|----------|-------------|" )]' \
                'exec("for r in fil:\n d=r[10][:117]+\x27...\x27 if len(r[10])>120 else r[10]\n print(\x27| \x27+r[0]+\x27 | \x27+r[3]+\x27 | \x27+r[14]+\x27:\x27+r[16]+\x27 | \x27+d+\x27 |\x27)")' \
                > "$PY"
              KICS_CSV="$REPORT_DIR/results.csv" python3 "$PY"
              rm -f "$PY"
            fi
            echo ""
            echo "=== KICS scan complete ==="

  # â”€â”€ tfsec-only: tfsec scan only, no terraform plan â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Comment `atlantis plan -p scan-tfsec` on the PR to trigger.
  tfsec-only:
    plan:
      steps:
        - run: |
            echo "=== tfsec security scan (non-blocking + JSON export) ==="
            REPORT_DIR="/tmp/tfsec-report/$(date +%Y%m%d-%H%M%S)-PR${PULL_NUM}"
            mkdir -p "$REPORT_DIR"
            tfsec . --no-color --soft-fail --format json > "$REPORT_DIR/results.json" 2>&1 || true
            tfsec . --no-color --soft-fail
            echo ""
            echo "ğŸ“ tfsec report saved to: $REPORT_DIR/results.json"
            echo "=== tfsec scan complete ==="

  # â”€â”€ checkov-only: Checkov scan only, no terraform plan â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Comment `atlantis plan -p scan-checkov` on the PR to trigger.
  checkov-only:
    plan:
      steps:
        - run: |
            echo "=== Checkov security scan (non-blocking + CSV/JSON export) ==="
            REPORT_DIR="/tmp/checkov-report/$(date +%Y%m%d-%H%M%S)-PR${PULL_NUM}"
            mkdir -p "$REPORT_DIR"
            checkov -d . --quiet --compact --framework terraform --soft-fail \
              --output json > "$REPORT_DIR/results.json" 2>&1 || true
            checkov -d . --quiet --compact --framework terraform --soft-fail \
              --output csv > "$REPORT_DIR/results.csv" 2>&1 || true
            checkov -d . --compact --framework terraform --soft-fail
            echo ""
            echo "ğŸ“ Checkov report saved to: $REPORT_DIR"
            echo "   - CSV : $REPORT_DIR/results.csv"
            echo "   - JSON: $REPORT_DIR/results.json"
            echo "=== Checkov scan complete ==="
