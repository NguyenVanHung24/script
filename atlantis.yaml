# =============================================================================
# atlantis.yaml â€” Repo-level Atlantis configuration
# =============================================================================
version: 3

# â”€â”€â”€ PROJECTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Each project can be triggered individually from a PR comment.
# Use `atlantis plan -p <name>` to target a specific project.
projects:

  # â”€â”€ Main project: full scan + terraform plan + apply â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Triggered automatically on PR push (autoplan) or with: atlantis plan
  - name: alantis-demo
    dir: .
    workspace: default              # default workspace = main state file
    workflow: all-scans-plan        # runs all 3 scanners + init + plan
    apply_requirements:
      - approved                    # PR must be approved before atlantis apply
    autoplan:
      when_modified:
        - "*.tf"
        - "*.tfvars"
        - "atlantis.yaml"
      enabled: true

  # â”€â”€ KICS scan only â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Trigger with: atlantis plan -p scan-kics
  # This only runs KICS, no terraform plan is generated.
  - name: scan-kics
    dir: .
    workspace: kics                 # separate workspace to avoid lock conflicts
    workflow: kics-only
    autoplan:
      enabled: false                # never auto-trigger; only on explicit command

  # â”€â”€ tfsec scan only â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Trigger with: atlantis plan -p scan-tfsec
  - name: scan-tfsec
    dir: .
    workspace: tfsec
    workflow: tfsec-only
    autoplan:
      enabled: false

  # â”€â”€ Checkov scan only â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Trigger with: atlantis plan -p scan-checkov
  - name: scan-checkov
    dir: .
    workspace: checkov
    workflow: checkov-only
    autoplan:
      enabled: false

# â”€â”€â”€ WORKFLOWS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
workflows:

  # â”€â”€ all-scans-plan: KICS cháº¡y TRÆ¯á»šC TIÃŠN (non-blocking) + export CSV â”€â”€â”€â”€â”€
  all-scans-plan:
    plan:
      steps:
        # âœ… BÆ¯á»šC 1: KICS scan â€” NON-BLOCKING + export CSV/JSON report
        # DÃ¹ KICS tÃ¬m tháº¥y lá»—i, cÃ¡c bÆ°á»›c tiáº¿p theo váº«n tiáº¿p tá»¥c cháº¡y
        # CSV report Ä‘Æ°á»£c lÆ°u táº¡i: /tmp/kics-report/<timestamp>-PR<num>/
        - run: |
            echo "=== [1/5] KICS security scan (non-blocking) ==="
            REPORT_DIR="/tmp/kics-report/$(date +%Y%m%d-%H%M%S)-PR${PULL_NUM}"
            mkdir -p "$REPORT_DIR"
            kics scan \
              -p . \
              -q /app/assets/queries \
              --no-progress \
              --type Terraform \
              --report-formats csv,json \
              --output-path "$REPORT_DIR" \
              --ignore-on-exit results > /dev/null 2>&1
            if [ -f "$REPORT_DIR/results.csv" ]; then
              KICS_CSV="$REPORT_DIR/results.csv" python3 - <<'PYEOF'
import csv, sys, os
filepath = os.environ['KICS_CSV']
rows = []
try:
    with open(filepath, newline='', encoding='utf-8') as f:
        reader = csv.reader(f)
        next(reader)  # skip header
        for r in reader:
            if len(r) >= 17:
                rows.append(r)
except Exception as e:
    print(f"Error reading CSV: {e}"); sys.exit(0)

total = len(rows)
critical = sum(1 for r in rows if r[3].strip().upper() == 'CRITICAL')
high     = sum(1 for r in rows if r[3].strip().upper() == 'HIGH')
med      = sum(1 for r in rows if r[3].strip().upper() == 'MEDIUM')
print("### \U0001f510 KICS Security Scan Results")
print("")
print("| \U0001f4ca Total | \U0001f534 Critical | \U0001f7e0 High | \U0001f7e1 Medium |")
print("|---------|------------|--------|----------|")
print(f"| {total} | {critical} | {high} | {med} |")
print("")
filtered = [r for r in rows if r[3].strip().upper() in ('CRITICAL','HIGH','MEDIUM')]
if filtered:
    print("#### \u26a0\ufe0f Findings \u2014 Critical / High / Medium")
    print("")
    print("| Vulnerability | Severity | Resource | Description |")
    print("|--------------|----------|----------|-------------|")
    for r in filtered:
        name  = r[0].strip()
        sev   = r[3].strip()
        fname = r[14].strip()
        line  = r[16].strip()
        desc  = r[10].strip()
        if len(desc) > 120: desc = desc[:117] + '...'
        print(f"| {name} | {sev} | {fname}:{line} | {desc} |")
else:
    print("\u2705 No CRITICAL / HIGH / MEDIUM findings.")
PYEOF
            fi
            echo ""
            echo "=== KICS scan complete ==="

        - run: |
            echo "=== [2/5] tfsec security scan (non-blocking + JSON export) ==="
            REPORT_DIR="/tmp/tfsec-report/$(date +%Y%m%d-%H%M%S)-PR${PULL_NUM}"
            mkdir -p "$REPORT_DIR"
            tfsec . --no-color --soft-fail --format json > "$REPORT_DIR/results.json" 2>&1 || true
            tfsec . --no-color --soft-fail
            echo ""
            echo "ğŸ“ tfsec report saved to: $REPORT_DIR/results.json"
            echo "=== tfsec scan complete ==="

        - run: |
            echo "=== [3/5] Checkov security scan (non-blocking + CSV/JSON export) ==="
            REPORT_DIR="/tmp/checkov-report/$(date +%Y%m%d-%H%M%S)-PR${PULL_NUM}"
            mkdir -p "$REPORT_DIR"
            checkov -d . --quiet --compact --framework terraform --soft-fail \
              --output json > "$REPORT_DIR/results.json" 2>&1 || true
            checkov -d . --quiet --compact --framework terraform --soft-fail \
              --output csv > "$REPORT_DIR/results.csv" 2>&1 || true
            checkov -d . --compact --framework terraform --soft-fail
            echo ""
            echo "ğŸ“ Checkov report saved to: $REPORT_DIR"
            echo "   - CSV : $REPORT_DIR/results.csv"
            echo "   - JSON: $REPORT_DIR/results.json"
            echo "=== Checkov scan complete ==="

        - init   # BÆ°á»›c 4: terraform init
        - plan   # BÆ°á»›c 5: terraform plan (káº¿t quáº£ post lÃªn PR comment)

    apply:
      steps:
        - apply  # runs terraform apply with the saved plan file

  # â”€â”€ kics-only: KICS scan only + export CSV, no terraform plan â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Comment `atlantis plan -p scan-kics` on the PR to trigger.
  kics-only:
    plan:
      steps:
        - run: |
            echo "=== KICS security scan ==="
            REPORT_DIR="/tmp/kics-report/$(date +%Y%m%d-%H%M%S)-PR${PULL_NUM}"
            mkdir -p "$REPORT_DIR"
            kics scan \
              -p . \
              -q /app/assets/queries \
              --no-progress \
              --type Terraform \
              --report-formats csv,json \
              --output-path "$REPORT_DIR" \
              --ignore-on-exit results > /dev/null 2>&1
            if [ -f "$REPORT_DIR/results.csv" ]; then
              KICS_CSV="$REPORT_DIR/results.csv" python3 - <<'PYEOF'
import csv, sys, os
filepath = os.environ['KICS_CSV']
rows = []
try:
    with open(filepath, newline='', encoding='utf-8') as f:
        reader = csv.reader(f)
        next(reader)  # skip header
        for r in reader:
            if len(r) >= 17:
                rows.append(r)
except Exception as e:
    print(f"Error reading CSV: {e}"); sys.exit(0)

total    = len(rows)
critical = sum(1 for r in rows if r[3].strip().upper() == 'CRITICAL')
high     = sum(1 for r in rows if r[3].strip().upper() == 'HIGH')
med      = sum(1 for r in rows if r[3].strip().upper() == 'MEDIUM')
low      = sum(1 for r in rows if r[3].strip().upper() == 'LOW')
info     = sum(1 for r in rows if r[3].strip().upper() == 'INFO')
print("### \U0001f510 KICS Security Scan Results")
print("")
print("| \U0001f4ca Total | \U0001f534 Critical | \U0001f7e0 High | \U0001f7e1 Medium | \U0001f535 Low | \u26aa Info |")
print("|---------|------------|--------|----------|-------|------|")
print(f"| {total} | {critical} | {high} | {med} | {low} | {info} |")
print("")
filtered = [r for r in rows if r[3].strip().upper() in ('CRITICAL','HIGH','MEDIUM')]
if filtered:
    print("#### \u26a0\ufe0f Findings \u2014 Critical / High / Medium")
    print("")
    print("| Vulnerability | Severity | Resource | Description |")
    print("|--------------|----------|----------|-------------|")
    for r in filtered:
        name  = r[0].strip()
        sev   = r[3].strip()
        fname = r[14].strip()
        line  = r[16].strip()
        desc  = r[10].strip()
        if len(desc) > 120: desc = desc[:117] + '...'
        print(f"| {name} | {sev} | {fname}:{line} | {desc} |")
else:
    print("\u2705 No CRITICAL / HIGH / MEDIUM findings.")
PYEOF
            fi
            echo ""
            echo "=== KICS scan complete ==="

  # â”€â”€ tfsec-only: tfsec scan only, no terraform plan â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Comment `atlantis plan -p scan-tfsec` on the PR to trigger.
  tfsec-only:
    plan:
      steps:
        - run: |
            echo "=== tfsec security scan (non-blocking + JSON export) ==="
            REPORT_DIR="/tmp/tfsec-report/$(date +%Y%m%d-%H%M%S)-PR${PULL_NUM}"
            mkdir -p "$REPORT_DIR"
            tfsec . --no-color --soft-fail --format json > "$REPORT_DIR/results.json" 2>&1 || true
            tfsec . --no-color --soft-fail
            echo ""
            echo "ğŸ“ tfsec report saved to: $REPORT_DIR/results.json"
            echo "=== tfsec scan complete ==="

  # â”€â”€ checkov-only: Checkov scan only, no terraform plan â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Comment `atlantis plan -p scan-checkov` on the PR to trigger.
  checkov-only:
    plan:
      steps:
        - run: |
            echo "=== Checkov security scan (non-blocking + CSV/JSON export) ==="
            REPORT_DIR="/tmp/checkov-report/$(date +%Y%m%d-%H%M%S)-PR${PULL_NUM}"
            mkdir -p "$REPORT_DIR"
            checkov -d . --quiet --compact --framework terraform --soft-fail \
              --output json > "$REPORT_DIR/results.json" 2>&1 || true
            checkov -d . --quiet --compact --framework terraform --soft-fail \
              --output csv > "$REPORT_DIR/results.csv" 2>&1 || true
            checkov -d . --compact --framework terraform --soft-fail
            echo ""
            echo "ğŸ“ Checkov report saved to: $REPORT_DIR"
            echo "   - CSV : $REPORT_DIR/results.csv"
            echo "   - JSON: $REPORT_DIR/results.json"
            echo "=== Checkov scan complete ==="
