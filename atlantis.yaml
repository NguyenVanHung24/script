version: 3

# ---------------------------------------------------------------------------
# Project definitions
# Each project maps a directory to a named workflow.
# apply_requirements ensures a human approves before Terraform applies.
# ---------------------------------------------------------------------------
projects:
  - name: alantis-demo
    dir: .
    workspace: default
    workflow: validate-scan-plan
    apply_requirements:
      - approved          # PR must be approved before atlantis apply
    autoplan:
      when_modified:
        - "*.tf"
        - "*.tfvars"
        - "atlantis.yaml"
      enabled: true

# ---------------------------------------------------------------------------
# Workflow: validate-scan-plan
#
# Plan phase steps (executed in order):
#   1. terraform fmt -check     → fail if code is not properly formatted
#   2. terraform validate       → syntax + internal consistency check
#   3. checkov (KICS-style)     → security & compliance scan
#        --soft-fail keeps the output visible but does NOT block the plan.
#        Remove --soft-fail to make Checkov failures block the plan.
#   4. init                     → standard atlantis init step
#   5. plan                     → standard atlantis plan step
#
# Apply phase steps:
#   1. apply                    → standard atlantis apply step
# ---------------------------------------------------------------------------
workflows:
  validate-scan-plan:
    plan:
      steps:
        # ── Formatting check ────────────────────────────────────────────────
        - run: |
            echo "=== [1/4] Terraform format check ==="
            terraform fmt -check -recursive .
            echo "Format check passed."

        # ── Built-in validation ──────────────────────────────────────────────
        - run: |
            echo "=== [2/4] Terraform validate ==="
            terraform validate
            echo "Validation passed."

        # ── KICS security scan ───────────────────────────────────────────────────
        # KICS (Keeping Infrastructure as Code Secure) scans Terraform files
        # for misconfigurations, security issues, and compliance violations.
        # Key flags:
        #   -p .                 : path to scan (current directory)
        #   --no-progress        : suppress progress bar for clean CI output
        #   --report-formats cli : human-readable output in PR comments
        #   --type Terraform     : only scan Terraform files
        #   --ignore-on-exit results : exit 0 even when findings exist (soft-fail)
        #                            remove this flag to block the plan on findings
        - run: |
            echo "=== [3/4] KICS security scan ==="
            kics scan \
              -p . \
              --no-progress \
              --report-formats cli \
              --type Terraform \
              --ignore-on-exit results
            echo "KICS scan complete."

        # ── Terraform init + plan ────────────────────────────────────────────
        - init
        - plan

    apply:
      steps:
        - apply
