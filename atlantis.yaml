# =============================================================================
# atlantis.yaml — Repo-level Atlantis configuration
# =============================================================================
version: 3

# ─── PROJECTS ────────────────────────────────────────────────────────────────
# Each project can be triggered individually from a PR comment.
# Use `atlantis plan -p <name>` to target a specific project.
projects:

  # ── Main project: full scan + terraform plan + apply ─────────────────────
  # Triggered automatically on PR push (autoplan) or with: atlantis plan
  - name: alantis-demo
    dir: .
    workspace: default              # default workspace = main state file
    workflow: all-scans-plan        # runs all 3 scanners + init + plan
    apply_requirements:
      - approved                    # PR must be approved before atlantis apply
    autoplan:
      when_modified:
        - "*.tf"
        - "*.tfvars"
        - "atlantis.yaml"
      enabled: true

  # ── KICS scan only ────────────────────────────────────────────────────────
  # Trigger with: atlantis plan -p scan-kics
  # This only runs KICS, no terraform plan is generated.
  - name: scan-kics
    dir: .
    workspace: kics                 # separate workspace to avoid lock conflicts
    workflow: kics-only
    autoplan:
      enabled: false                # never auto-trigger; only on explicit command

  # ── tfsec scan only ───────────────────────────────────────────────────────
  # Trigger with: atlantis plan -p scan-tfsec
  - name: scan-tfsec
    dir: .
    workspace: tfsec
    workflow: tfsec-only
    autoplan:
      enabled: false

  # ── Checkov scan only ─────────────────────────────────────────────────────
  # Trigger with: atlantis plan -p scan-checkov
  - name: scan-checkov
    dir: .
    workspace: checkov
    workflow: checkov-only
    autoplan:
      enabled: false

# ─── WORKFLOWS ────────────────────────────────────────────────────────────────
workflows:

  # ── all-scans-plan: KICS chạy TRƯỚC TIÊN (blocking), rồi mới init + plan ──
  all-scans-plan:
    plan:
      steps:
        # ✅ BƯỚC 1: KICS scan — BLOCKING (nếu KICS fail, plan sẽ không chạy)
        # Xóa --ignore-on-exit để chặn plan khi có lỗi HIGH severity
        - run: |
            echo "=== [1/5] KICS security scan (BLOCKING) ==="
            kics scan \
              -p . \
              -q /app/assets/queries \
              --no-progress \
              --type Terraform
            echo "=== KICS scan passed — no blocking issues found ==="

        - run: |
            echo "=== [2/5] tfsec security scan ==="
            tfsec . --no-color --soft-fail
            echo "tfsec scan complete."

        - run: |
            echo "=== [3/5] Checkov security scan ==="
            checkov -d . --quiet --compact --framework terraform --soft-fail
            echo "Checkov scan complete."

        - init   # Bước 4: terraform init
        - plan   # Bước 5: terraform plan (kết quả post lên PR comment)

    apply:
      steps:
        - apply  # runs terraform apply with the saved plan file

  # ── kics-only: KICS scan only, no terraform plan ──────────────────────────
  # Comment `atlantis plan -p scan-kics` on the PR to trigger.
  kics-only:
    plan:
      steps:
        - run: |
            echo "=== KICS security scan ==="
            kics scan \
              -p . \
              -q /app/assets/queries \
              --no-progress \
              --type Terraform \
              --ignore-on-exit results
            echo "KICS scan complete."

  # ── tfsec-only: tfsec scan only, no terraform plan ────────────────────────
  # Comment `atlantis plan -p scan-tfsec` on the PR to trigger.
  tfsec-only:
    plan:
      steps:
        - run: |
            echo "=== tfsec security scan ==="
            tfsec . --no-color --soft-fail
            echo "tfsec scan complete."

  # ── checkov-only: Checkov scan only, no terraform plan ────────────────────
  # Comment `atlantis plan -p scan-checkov` on the PR to trigger.
  checkov-only:
    plan:
      steps:
        - run: |
            echo "=== Checkov security scan ==="
            checkov -d . --quiet --compact --framework terraform --soft-fail
            echo "Checkov scan complete."
