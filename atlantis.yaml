# ─────────────────────────────────────────────────────────────────────────────
# atlantis.yaml — Repo-level Atlantis configuration
#
# This file lives INSIDE the repository and tells Atlantis:
#   • Which directories/workspaces are "projects"
#   • Which workflow each project should follow
#   • What security gates must pass before `atlantis apply` is allowed
# ─────────────────────────────────────────────────────────────────────────────
version: 3   # Schema version — always 3 for current Atlantis

# ─── PROJECTS ────────────────────────────────────────────────────────────────
# A project = one Terraform root module that Atlantis manages.
# You can have many projects (one per subdirectory, workspace, etc.)
projects:
  - name: alantis-demo            # Friendly label shown in PR comments
    dir: .                        # Relative path to the Terraform root (. = repo root)
    workspace: default            # Terraform workspace name
    workflow: validate-scan-plan  # Which workflow block below to use for this project
    apply_requirements:
      - approved                  # A reviewer MUST approve the PR before `atlantis apply` runs
    autoplan:                     # Automatically run `plan` when a PR is opened/updated
      when_modified:
        - "*.tf"          # Re-plan when any .tf file changes
        - "*.tfvars"      # Re-plan when variable files change
        - "atlantis.yaml" # Re-plan when this config itself changes
      enabled: true       # Turn autoplan on (set false to require manual `atlantis plan`)

# ─── WORKFLOWS ───────────────────────────────────────────────────────────────
# A workflow defines the exact steps that run for `plan` and `apply`.
# Steps run in order; if any step exits non-zero the whole workflow fails.
# Built-in steps (init, plan, apply) are Atlantis built-ins.
# `run:` steps are raw shell commands executed inside the cloned repo directory.
# ─────────────────────────────────────────────────────────────────────────────
workflows:
  validate-scan-plan:   # Must match the `workflow:` field in the project above
    plan:               # Steps that run when `atlantis plan` is triggered
      steps:

        # ── Step 1: Formatting check ──────────────────────────────────────────
        # `terraform fmt -check` reads every .tf file and verifies it matches
        # canonical HCL formatting. It does NOT rewrite files — it only reports.
        # Exit code 1 if any file is unformatted → blocks the plan.
        - run: |
            echo "=== [1/4] Terraform format check ==="
            terraform fmt -check -recursive .   # -recursive: also check subdirectories
            echo "Format check passed."

        # ── Step 2: Terraform validate ───────────────────────────────────────
        # `terraform validate` checks that all HCL syntax is correct and that
        # references between resources are internally consistent.
        # It does NOT call the cloud API — purely local, no credentials needed.
        - run: |
            echo "=== [2/4] Terraform validate ==="
            terraform validate
            echo "Validation passed."

        # ── Step 3: tfsec security scan ────────────────────────────────────────
        # tfsec (by Aqua Security) statically analyzes Terraform files for
        # misconfigurations against 150+ built-in security checks covering
        # AWS, Azure, GCP, and common IaC mistakes.
        - run: |
            echo "=== [3/4] tfsec security scan ==="
            tfsec . \
              --no-color \          # plain text output (no ANSI colors in PR comments)
              --soft-fail           # exit 0 even when findings exist (soft-fail)
                                    # → remove --soft-fail to BLOCK the plan on findings
            echo "tfsec scan complete."

        # ── Step 4a: terraform init ───────────────────────────────────────────
        # Atlantis built-in: runs `terraform init` to download providers/modules.
        # Uses the provider cache mounted in the container for speed.
        - init

        # ── Step 4b: terraform plan ───────────────────────────────────────────
        # Atlantis built-in: runs `terraform plan` and posts the output as a
        # PR comment so reviewers can see exactly what will change.
        - plan

    apply:        # Steps that run when `atlantis apply` is triggered (after approval)
      steps:
        # Atlantis built-in: runs `terraform apply` with the saved plan file.
        # Only reachable after all `apply_requirements` (e.g., `approved`) are met.
        - apply
