# =============================================================================
# repos.yaml — Atlantis SERVER-SIDE repository configuration
#
# This is the "admin layer" — controls what repos are allowed to configure
# in their own atlantis.yaml files.
#
# repos.yaml = server operator policy
# atlantis.yaml = per-repo developer config (within policy)
# =============================================================================

repos:
  # Applies to ALL repositories connected to this Atlantis instance.
  - id: /.*/

    allowed_overrides:
      - workflow            # repos may define custom workflow names
      - apply_requirements  # repos may set their own approval gates

    # Must be true for repos to use `run:` shell steps in workflows.
    allow_custom_workflows: true

    # ==========================================================================
    # pre_workflow_hooks: run BEFORE any workflow (plan or apply) on every repo.
    # This is the server-operator enforcement layer — developers cannot skip it.
    # ==========================================================================
    pre_workflow_hooks:
      - run: |
          echo "=== [pre_workflow_hook] KICS security scan ==="
          kics scan \
            -p "$BASE_REPO_DIR" \
            -q /app/assets/queries \
            --no-progress \
            --type Terraform \
            --ignore-on-exit results
          echo "=== KICS scan complete ==="
